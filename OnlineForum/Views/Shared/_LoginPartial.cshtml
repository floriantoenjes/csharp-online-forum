@using Microsoft.AspNetCore.Identity
@using OnlineForum.Services

@inject SignInManager<User> SignInManager
@inject UserManager<User> UserManager

@inject NotificationService NotificationService

@{
    var notifications = NotificationService.GetNotificationsForUser(Convert.ToInt32(UserManager.GetUserId(User)));
    var notificationCount = notifications.Count;
}

<ul class="navbar-nav">
    @if (SignInManager.IsSignedIn(User))
    {
        <li class="nav-item">
            <a id="manage" class="nav-link text-dark" asp-area="Identity" asp-page="/Account/Manage/Index" title="Manage">Hello @UserManager.GetUserName(User)!</a>
        </li>
        <li class="nav-item mr-4">
            <form id="logoutForm" class="form-inline" action="@Url.Action("ControlPanel", "ControlPanel", new {area = ""})">
                <button id="logout" type="submit" class="nav-link btn btn-link text-dark">Control Panel</button>
            </form>
        </li>
        <li class="nav-item mr-4 position-relative">
            <div id="notification-bell" class="mt-1" style="cursor: pointer">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-bell" viewBox="0 0 16 16">
                    <path d="M8 16a2 2 0 0 0 2-2H6a2 2 0 0 0 2 2zM8 1.918l-.797.161A4.002 4.002 0 0 0 4 6c0 .628-.134 2.197-.459 3.742-.16.767-.376 1.566-.663 2.258h10.244c-.287-.692-.502-1.49-.663-2.258C12.134 8.197 12 6.628 12 6a4.002 4.002 0 0 0-3.203-3.92L8 1.917zM14.22 12c.223.447.481.801.78 1H1c.299-.199.557-.553.78-1C2.68 10.2 3 6.88 3 6c0-2.42 1.72-4.44 4.005-4.901a1 1 0 1 1 1.99 0A5.002 5.002 0 0 1 13 6c0 .88.32 4.2 1.22 6z"/>
                </svg>
                @if(notificationCount > 0)
                {
                    <span class="badge rounded-pill bg-primary text-white">
                        @notificationCount
                    </span>
                }
            </div>
            <div class="bg-white border notification-container position-absolute" style="left: -10em; z-index: 1">
                <ul class="list-unstyled p-4">
                    @foreach (var notification in notifications)
                    {
                        <li>
                            <p>
                                @switch (notification.NotificationType)
                                {
                                    case NotificationType.NewPost:
                                        @Html.ActionLink("New Post in Thread", "Thread", "Thread", new {threadId = notification.TypeIdentifier});
                                        break;
                                    
                                    case NotificationType.PrivateMessage:
                                        @Html.ActionLink("New Private Message", "ControlPanel", "ControlPanel");
                                        break;
                                }
                            </p>
                            <hr>
                        </li>
                    }
                </ul>
            </div>
        </li>
        <li class="nav-item">
            <form id="logoutForm" class="form-inline" asp-area="Identity" asp-page="/Account/Logout" asp-route-returnUrl="@Url.Action("Index", "Home", new {area = ""})">
                <button id="logout" type="submit" class="nav-link btn btn-link text-dark">Logout</button>
            </form>
        </li>
    }
    else
    {
        <li class="nav-item">
            <a class="nav-link text-dark" id="register" asp-area="Identity" asp-page="/Account/Register">Register</a>
        </li>
        <li class="nav-item">
            <a class="nav-link text-dark" id="login" asp-area="Identity" asp-page="/Account/Login">Login</a>
        </li>
    }
</ul>